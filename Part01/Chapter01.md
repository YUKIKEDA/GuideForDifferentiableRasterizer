# 第1章 数学の基礎

微分可能ラスタライザを理解し、最終的に nvdiffrast 相当のライブラリを自作するには、**線形代数**・**微積分**・**重心座標**の三本柱が不可欠です。本章では、後の章で繰り返し登場する概念を「なぜ必要か」を意識しながら整理します。すでに習得済みの読者は復習として、初めての読者は本教材の共通言語として身につけてください。

---

## 1.1 線形代数（ベクトル・行列・変換）

### 1.1.1 ベクトルとその演算

**ベクトル**は、本教材では主に **列ベクトル** として扱います。

$$
\mathbf{v} = \begin{pmatrix} x \\ y \\ z \\ w \end{pmatrix} \in \mathbb{R}^4
$$

3D グラフィックスでは **同次座標**（斉次座標）が標準です。$(x, y, z, w)$ のうち $w \ne 0$ のとき、実際の 3D 点は $(x/w,\, y/w,\, z/w)$ と解釈します。$w=1$ のときはそのまま $(x,y,z)$ が 3D 座標です。射影変換（透視）は「$w$ で割る」操作と密接に関係し、微分可能ラスタライザでは **$1/w$ の補間** とその勾配が重要になります（Part III で詳述）。

- **内積（スカラー積）**: $\mathbf{a} \cdot \mathbf{b} = \mathbf{a}^\top \mathbf{b} = \sum_i a_i b_i$  
  - 長さ・角度・「あるベクトルへの正射影」の計算に使います。エッジ関数（三角形の内外判定）も内積で表現できます。
- **外積（ベクトル積）**: $\mathbf{a} \times \mathbf{b}$  
  - 3D では「法線ベクトル」「三角形の符号付き面積」の計算に使います。ラスタライザではエッジの向きや背面カリングに登場します。

**ノルム**: $\|\mathbf{v}\| = \sqrt{\mathbf{v} \cdot \mathbf{v}}$。単位ベクトルは $\hat{\mathbf{v}} = \mathbf{v} / \|\mathbf{v}\|$ です。

---

### 1.1.2 行列と線形写像

$m \times n$ 行列 $\mathbf{A}$ は、$\mathbb{R}^n \to \mathbb{R}^m$ の **線形写像** を表します。

$$
\mathbf{y} = \mathbf{A} \mathbf{x}, \quad y_i = \sum_{j=1}^{n} A_{ij} x_j
$$

- **行列の積**: $(\mathbf{A}\mathbf{B})_{ik} = \sum_j A_{ij} B_{jk}$。写像の合成に対応します。
- **転置**: $(\mathbf{A}^\top)_{ji} = A_{ij}$。内積 $\mathbf{a}^\top \mathbf{b}$ を「$\mathbf{a}$ を転置してから行列として掛ける」と見ると、後の **勾配（偏微分のベクトル）** と整合します。
- **逆行列**: $\mathbf{A}^{-1}$ が存在するとき $\mathbf{A}^{-1}\mathbf{A} = \mathbf{A}\mathbf{A}^{-1} = \mathbf{I}$。逆変換を表し、逆伝播で「前の層への勾配」を求める際に形が似た計算が出ます。

---

### 1.1.3 グラフィックスで使う変換行列

3D レンダリングでは、**モデル・ビュー・射影（MVP）** の三つの変換を組み合わせます。いずれも $4\times4$ の同次座標用行列で、頂点は $\mathbf{p}' = \mathbf{M}\,\mathbf{p}$ のように変換されます。

| 変換 | 役割 | 備考 |
|------|------|------|
| **モデル変換** | オブジェクト空間 → ワールド空間 | スケール・回転・平行移動 |
| **ビュー変換** | ワールド空間 → カメラ（ビュー）空間 | カメラの位置・向き |
| **射影変換** | ビュー空間 → クリップ空間 | 透視なら $w$ に深度情報が入る |

**重要な性質**: 透視射影行列を掛けたあとの $w$ 成分は、多くの場合 **ビュー空間での深度（またはその線形関数）** になっています。ラスタライザでは「ピクセルごとに $1/w$ を補間し、深度や属性を $1/w$ で補間してから $w$ を掛け直す」という **パースペクティブ補正** を行います。この $w$ と $1/w$ の扱いが、後の **微分可能な属性補間** で偏微分の式にそのまま現れます。

**回転行列**は直交行列（$\mathbf{R}^\top \mathbf{R} = \mathbf{I}$）で、ノルムを保ちます。**スケール行列**は対角行列、**平行移動**は同次座標の第 4 列（または行）で表現します。

---

### 1.1.4 本教材での表記の約束

- スカラー: 小文字イタリック $a$, $\lambda$
- ベクトル: 太字小文字 $\mathbf{v}$, $\mathbf{x}$（列ベクトル）
- 行列: 太字大文字 $\mathbf{A}$, $\mathbf{M}$
- 座標の成分: $x, y, z, w$ または $p_x, p_y, p_z, p_w$

これらは Part II 以降でも一貫して使います。

---

## 1.2 微積分（偏微分・連鎖律・ヤコビ行列）

微分可能ラスタライザの「微分可能」は、**損失関数から頂点位置・UV・テクスチャなどへ勾配が逆伝播できる**ことを意味します。そのために、**偏微分**・**連鎖律**・**ヤコビ行列**が常に登場します。

### 1.2.1 偏微分と勾配

多変数関数 $f(x_1, \ldots, x_n)$ の **偏微分** $\frac{\partial f}{\partial x_i}$ は、「$x_i$ 以外を固定して $x_i$ だけで微分したもの」です。

**勾配（gradient）** は、すべての変数に関する偏微分を並べた **列ベクトル** です。

$$
\nabla f = \begin{pmatrix} \frac{\partial f}{\partial x_1} \\ \vdots \\ \frac{\partial f}{\partial x_n} \end{pmatrix}
$$

最適化では「$f$ を増やす方向」が $\nabla f$、「減らす方向」が $-\nabla f$ なので、勾配降下法では $\mathbf{x} \leftarrow \mathbf{x} - \eta \nabla f$ のように更新します。逆レンダリングでは「画像の損失」を「頂点座標・UV・テクスチャ」で偏微分した勾配が必要になります。

---

### 1.2.2 連鎖律（チェーンルール）

$y = f(u)$, $u = g(x)$ のとき、

$$
\frac{dy}{dx} = \frac{dy}{du} \cdot \frac{du}{dx}
$$

多変数版では、**スカラー** $L$ が $L = f(y_1,\ldots,y_m)$、$y_j = g_j(x_1,\ldots,x_n)$ のとき、

$$
\frac{\partial L}{\partial x_i} = \sum_{j=1}^{m} \frac{\partial L}{\partial y_j} \frac{\partial y_j}{\partial x_i}
$$

「上流の勾配 $\frac{\partial L}{\partial y_j}$」に「その変数から下流への感度 $\frac{\partial y_j}{\partial x_i}$」を掛けて足し合わせる、という形です。これは **誤差逆伝播法（backpropagation）** そのものです。微分可能ラスタライザでは、

- 損失 $L$ → ピクセル色 → 補間された属性 → 重心座標 $(u,v)$ → 頂点位置

といった長い鎖を、各段階で $\frac{\partial (\text{出力})}{\partial (\text{入力})}$ を掛けながら逆に辿ります。特に **重心座標から頂点位置への勾配** は、初心者が最もつまずきやすい部分の一つなので、Part III で式を丁寧に扱います。

---

### 1.2.3 ヤコビ行列

ベクトル値関数 $\mathbf{y} = \mathbf{f}(\mathbf{x})$、$\mathbf{x}\in\mathbb{R}^n$, $\mathbf{y}\in\mathbb{R}^m$ の **ヤコビ行列** は、

$$
\mathbf{J} = \frac{\partial \mathbf{y}}{\partial \mathbf{x}}, \quad J_{ji} = \frac{\partial y_j}{\partial x_i}
$$

です（$j$ が行・$i$ が列とする流儀が多く、文献により転置の取り方に注意）。  
スカラー損失 $L(\mathbf{y})$ の $\mathbf{x}$ への勾配は、連鎖律より

$$
\nabla_{\mathbf{x}} L = \mathbf{J}^\top \nabla_{\mathbf{y}} L
$$

と書けます。つまり「上流の勾配ベクトル $\nabla_{\mathbf{y}} L$ に、ヤコビの転置を左から掛ける」ことで、一つ前の変数への勾配が得られます。  
ラスタライザでは、例えば「スクリーン空間の重心座標 $(u,v)$ → クリップ空間の頂点座標」といった写像のヤコビを扱うと、解析的に勾配を導出しやすくなります（Part IV の nvdiffrast 風の導出で活用します）。

---

### 1.2.4 よく使う微分公式

- $\frac{\partial}{\partial x_i}(\mathbf{a}^\top \mathbf{x}) = a_i$ → $\nabla_{\mathbf{x}}(\mathbf{a}^\top \mathbf{x}) = \mathbf{a}$
- $\frac{\partial}{\partial x_i}(\mathbf{x}^\top \mathbf{A} \mathbf{x})$（$\mathbf{A}$ 対称のとき）$= (\mathbf{A}\mathbf{x})_i + (\mathbf{A}^\top\mathbf{x})_i = 2(\mathbf{A}\mathbf{x})_i$ → $\nabla_{\mathbf{x}}(\mathbf{x}^\top \mathbf{A} \mathbf{x}) = 2\mathbf{A}\mathbf{x}$
- $\frac{\partial (1/x)}{\partial x} = -\frac{1}{x^2}$  
  パースペクティブ補正で $1/w$ を補間するため、$w$ に対する損失の勾配には $-1/w^2$ が現れます。

---

## 1.3 重心座標（定義・性質・応用）

三角形の内部および辺上の点を、3 頂点の「重み付き和」で一意に表すのが **重心座標** です。ラスタライザでは **どのピクセルがどの三角形に属するか** と **属性（色・深度・UV・法線など）の補間** の両方で中心的な役割を果たします。微分可能ラスタライザでは、**重心座標の計算式** と **その頂点位置などへの偏微分** を正確に扱うことが必須です。

### 1.3.1 定義

三角形の 3 頂点を $\mathbf{p}_0, \mathbf{p}_1, \mathbf{p}_2$（いずれも 2D または 3D）とします。三角形の内部または辺上の点 $\mathbf{p}$ に対して、次の式を満たす **重心座標** $(b_0, b_1, b_2)$ が一意に存在します。

$$
\mathbf{p} = b_0 \mathbf{p}_0 + b_1 \mathbf{p}_1 + b_2 \mathbf{p}_2, \qquad b_0 + b_1 + b_2 = 1, \quad b_i \ge 0
$$

$b_i \ge 0$ のとき $\mathbf{p}$ は三角形の内部または辺上、どれかが負なら外側です。  
2D では条件 $b_0+b_1+b_2=1$ と「2 本の独立な座標軸」から $b_0,b_1,b_2$ のうち 2 つが決まり、残りは $1-b_0-b_1$ などで求まります。そのため、実装では **2 つのパラメータ**（多くの場合 $u=b_1$, $v=b_2$ とし、$b_0=1-u-v$）を使います。

---

### 1.3.2 面積比による表現とエッジ関数

三角形の **符号付き面積** を使うと、重心座標を明示的な式で書けます。  
2D で $\mathbf{p}_0, \mathbf{p}_1, \mathbf{p}_2$ が反時計回りのとき、三角形の符号付き面積は

$$
A = \frac{1}{2}\bigl( (x_1-x_0)(y_2-y_0) - (x_2-x_0)(y_1-y_0) \bigr)
$$

です。点 $\mathbf{p}$ と 2 頂点でできる 3 つの小三角形の符号付き面積を $A_0, A_1, A_2$ とすると、

$$
b_0 = \frac{A_0}{A}, \quad b_1 = \frac{A_1}{A}, \quad b_2 = \frac{A_2}{A}
$$

となります。ここで $A_0$ は「$\mathbf{p}$ と $\mathbf{p}_1, \mathbf{p}_2$ の三角形」の面積（符号付き）、同様に $A_1$, $A_2$ を定義します。  
この「小三角形の面積」は、**エッジ関数** の形で書くことが多く、ラスタライザの内外判定と一致します。

- エッジ $e_{01}$（頂点 0→1）について: エッジの左側を正とする符号付き距離（または面積の 2 倍）を $E_{01}(\mathbf{p})$ とすると、$E_{01}(\mathbf{p}) \ge 0$ が「$\mathbf{p}$ がエッジの左側」を表します。
- 3 本のエッジについて同様の不等式が成り立てば、$\mathbf{p}$ は三角形の内部です。
- $b_i$ は「対辺に向かうエッジ関数の値」を全体の面積で割ったものと対応します。

この対応により、**ピクセル中心が三角形の内側かどうか** と **そのピクセルでの重心座標** を、同じエッジ関数ベースの計算で求められます（Part III）。

---

### 1.3.3 属性の補間

頂点に属性（色 $\mathbf{c}_i$、深度 $z_i$、UV $\mathbf{t}_i$、法線 $\mathbf{n}_i$ など）が与えられているとき、重心座標 $(b_0, b_1, b_2)$ での **線形補間** は

$$
\mathbf{c} = b_0 \mathbf{c}_0 + b_1 \mathbf{c}_1 + b_2 \mathbf{c}_2
$$

のように書けます。  
しかし **透視投影下では**、正しく見える補間は「属性を $w$（または深度）で重み付けした補間」です。多くのパイプラインでは、

- スクリーン空間では **$1/w$ と「属性/$w$」を線形補間** し、
- 補間結果の「(属性/$w$) / (1/$w$)」として属性を復元する

という **パースペクティブ補正** を行います。つまり、**重心座標はスクリーン空間で線形に使い、補間される量は $1/w$ と属性/$w$** です。この違いが、**重心座標 $(u,v)$ から頂点座標や $w$ への偏微分** を複雑にし、かつ微分可能ラスタライザで正確に逆伝播するために必須の部分です（Part III で式を追います）。

---

### 1.3.4 重心座標の微分 — なぜ重要か

逆伝播では「ピクセルでの損失」が「補間された属性」を通じて「重心座標 $(u,v)$」に伝わり、さらに「頂点位置」に伝わります。そのため、

- $\frac{\partial L}{\partial u}, \frac{\partial L}{\partial v}$ から
- $\frac{\partial L}{\partial \mathbf{p}_0}, \frac{\partial L}{\partial \mathbf{p}_1}, \frac{\partial L}{\partial \mathbf{p}_2}$

を求める必要があります。  
重心座標は「頂点の位置の関数」なので、$u(\mathbf{p}_0,\mathbf{p}_1,\mathbf{p}_2)$, $v(\mathbf{p}_0,\mathbf{p}_1,\mathbf{p}_2)$ の偏微分（あるいは、スクリーン座標 $\mathbf{p}$ を固定したときの頂点移動に対する $u,v$ の変化率）を導出する必要があります。  
これは **解析的勾配**（nvdiffrast など）の核心の一つで、数式で整理しておくと実装とデバッグが楽になります。本章では「重心座標が頂点位置の関数であり、その微分が後で必要になる」ことだけ押さえておけば十分です。

---

### 1.3.5 まとめと次章への接続

- **線形代数**: ベクトル・行列・MVP 変換、とくに同次座標の $w$ と射影の関係を理解する。
- **微積分**: 偏微分・勾配・連鎖律・ヤコビ行列を「逆伝播の式」として扱えるようにする。
- **重心座標**: 定義・面積比・属性補間・パースペクティブ補正の考え方と、「その微分がのちに必要」という位置づけを理解する。

次章（第 2 章）では、**コンピュータグラフィックス入門** として、レンダリングパイプライン・座標変換・三角形ラスタライゼーション・深度バッファ・シェーディングの基礎を学び、第 1 章の数学がどのステップで使われるかを具体的に見ていきます。

---

*次: [第 2 章 コンピュータグラフィックス入門](Chapter02.md)*
