# 第10章 ソフトラスタライゼーション

第9章で、有限差分の限界と解析的勾配の必要性を学びました。本章では **ソフトラスタライゼーション** を扱います。離散的なピクセル帰属・深度テストを **ソフトマックスやシグモイド** で連続化し、勾配が自然に流れるようにする定式化です。10.1 で離散から連続への考え方、10.2 でピクセルごとの「重み」と勾配の定義、10.3 で Soft Rasterizer / DIB-R 系の定式化、10.4 でハイパーパラメータ（blend 係数・スケール）と安定性を整理します。第 11 章の解析的勾配（nvdiffrast）と対比することで、両方の設計の違いがはっきりします。

---

## 10.1 離散から連続へ（ソフトマックス・シグモイド）

### 10.1.1 離散判定の再確認

第 5 章で整理したように、ラスタライザの離散性は主に次の二つです。

1. **ピクセル帰属**: ピクセルが三角形の「内側」なら 1、外側なら 0。エッジ関数の符号で 0/1 が切り替わる。
2. **深度テスト**: 複数三角形が重なるとき、手前の三角形だけを選ぶ（argmax 的な選択）。

いずれも **境界で不連続** なため、そのままでは微分が 0 または未定義になります。

### 10.1.2 シグモイドによる連続化

**シグモイド** $\sigma(x) = \frac{1}{1 + e^{-x}}$ は、$x \to -\infty$ で 0、$x \to +\infty$ で 1 に滑らかに近づく関数です。  
エッジ関数 $E_{ij}(\mathbf{q})$ の代わりに、その **スケール付き** の値をシグモイドに入れると、「内側っぽさ」を連続な重み $w \in (0, 1)$ で表せます。

$$
w = \sigma\bigl( \alpha \cdot E(\mathbf{q}) \bigr)
$$

$\alpha > 0$ は **鋭さ** を決めるパラメータです。$\alpha$ が大きいほど 0/1 に近い形になり、小さいほど境界がなだらかになります。  
「3 本のエッジすべてで内側」という条件は、各エッジの $w_{ij}$ の積（または最小値のシグモイド）などで近似できます。いずれも **微分可能** なので、勾配が境界をまたいで流れます。

### 10.1.3 ソフトマックスによる選択の連続化

**深度テスト** の「手前の三角形を 1、他を 0 で選ぶ」を連続化するには、**ソフトマックス** が使われます。  
三角形 $t$ の深度（手前ほど小さい値、または奥ほど小さい値にスケール）を $d_t$ とすると、

$$
w_t = \frac{ \exp( -d_t / \tau ) }{ \sum_{t'} \exp( -d_{t'} / \tau ) }
$$

のように **重み** $w_t$ を定義します。$\tau > 0$ は **温度** で、小さいほど「手前の三角形にほぼ 1」に近づき、大きいほど複数三角形に重みが分散します。  
これにより、「どれが手前か」が **連続な重み** になり、すべての三角形に勾配が配分されます。ピクセルごとの色は、各三角形の色を $w_t$ で加重平均して得ます。

### 10.1.4 まとめ：離散から連続へ

| 離散演算 | 連続化の道具 | 役割 |
|----------|--------------|------|
| 内外判定（0/1） | シグモイド $\sigma(\alpha E)$ | 「内側っぽさ」を連続な重みにする |
| 手前の選択（argmax） | ソフトマックス $\mathrm{softmax}(-d/\tau)$ | 深度に応じた連続な重みでブレンドする |

どちらも **温度やスケール**（$\alpha$, $\tau$）で、どれだけ 0/1 に近づけるかを制御します。

---

## 10.2 ピクセルごとの「重み」と勾配の定義

### 10.2.1 ピクセルごとの寄与率

ソフトラスタライザでは、各 **ピクセル** $(i, j)$ に対して、各 **三角形** $t$（または各 **頂点・面**）からの **寄与率** $w_{t,i,j} \in [0, 1]$ を連続な関数で定義します。

- 三角形 $t$ がピクセル $(i,j)$ の近くにあれば $w_{t,i,j}$ は大きい。
- エッジから遠い内側なら $w_{t,i,j} \approx 1$、外側なら $w_{t,i,j} \approx 0$。
- 複数三角形が重なるときは、深度のソフトマックスで $\sum_t w_{t,i,j} = 1$ になるようにする。

ピクセル $(i,j)$ の色は、例えば

$$
C_{i,j} = \sum_t w_{t,i,j} \, c_{t,i,j}
$$

とします。$c_{t,i,j}$ は三角形 $t$ がそのピクセルに描いた場合の色（補間された属性やテクスチャの結果）です。

### 10.2.2 勾配の流れ

$w_{t,i,j}$ が **頂点位置・深度・エッジ関数** の微分可能な関数なので、損失 $L$ から

$$
\frac{\partial L}{\partial C_{i,j}} \quad \Rightarrow \quad \frac{\partial L}{\partial w_{t,i,j}}, \quad \frac{\partial L}{\partial c_{t,i,j}}
$$

と逆伝播できます。さらに $w_{t,i,j}$ はエッジ関数 $E$ や深度 $d_t$ の関数なので、

$$
\frac{\partial L}{\partial w_{t,i,j}} \frac{\partial w_{t,i,j}}{\partial E} \quad \Rightarrow \quad \frac{\partial L}{\partial (\text{頂点位置})}
$$

のように、**頂点位置** まで勾配が届きます。  
重要なのは、**境界付近でも** $w_{t,i,j}$ が 0 でも 1 でもない連続値なので、$\frac{\partial w_{t,i,j}}{\partial E} \ne 0$ となり、勾配が途切れないことです。

### 10.2.3 重みの設計と微分のトレードオフ

- 重みを **なだらか** にすると（$\alpha$ や $\tau$ を小さく）、境界がぼやけ、画像がソフトになる。一方で勾配は広い範囲に流れ、学習の初期では有利なことがある。
- 重みを **鋭く** すると（$\alpha$ や $\tau$ を大きく）、見た目はハードラスタに近いが、境界付近で勾配が急になり、数値的に不安定になりやすい。

実務では、**学習の進行に応じて** 温度やスケールを変える（アニーリング）ことがよく行われます。

---

## 10.3 Soft Rasterizer / DIB-R 系の定式化

### 10.3.1 Soft Rasterizer の考え方

**Soft Rasterizer**（Liu et al., 2019）では、各ピクセルについて **全三角形** からの寄与を、**深度のソフトマックス** で重み付けしてブレンドします。

- **順伝播**: 各三角形 $t$ について、ピクセル $(i,j)$ での「その三角形に属する度合い」$m_{t,i,j}$（シグモイドで連続化した内外判定）と、深度 $d_{t,i,j}$ を計算。重み $w_{t,i,j} \propto m_{t,i,j} \cdot \exp(-d_{t,i,j}/\tau)$ で正規化し、色を $C_{i,j} = \sum_t w_{t,i,j} c_{t,i,j}$ で合成。
- **逆伝播**: $w_{t,i,j}$ と $c_{t,i,j}$ は微分可能なので、自動微分または手で書いた backward で勾配が流れる。

「属する度合い」$m_{t,i,j}$ は、エッジ関数をシグモイドに入れたり、3 本のエッジの「内側っぽさ」の積にしたりして定義されます。

### 10.3.2 DIB-R の定式化

**DIB-R**（Differentiable Interpolation-Based Renderer, Chen et al., 2019）は、メッシュから画像を描く微分可能レンダラで、**ソフトラスタライゼーション** を採用しています。

- ラスタライゼーションを **ソフトな重み** で行い、深度テストもソフトマックスで連続化。
- シルエット（輪郭）の損失を別途定義し、形状が正しく見えるように補助することがある。
- 単一画像からの 3D 再構成などで広く使われている。

いずれも、「離散を連続で近似する」という共通の枠組みで、**重み** $w_{t,i,j}$ の設計と **温度パラメータ** が中心になります。

### 10.3.3 数式の整理

代表的な形を一つまとめます。ピクセル $\mathbf{p}$、三角形 $t$ のエッジ関数を $E_{t,k}(\mathbf{p})$（$k=1,2,3$）とし、三角形の符号付き面積の 2 倍を $2A_t$ とすると、

- **内側っぽさ**: $m_t(\mathbf{p}) = \sigma\bigl( \alpha \cdot \min_k E_{t,k}(\mathbf{p}) \bigr)$ または $m_t = \prod_k \sigma(\alpha E_{t,k})$ など。
- **深度重み**: $\tilde{w}_t = m_t \cdot \exp(-d_t / \tau)$、$w_t = \tilde{w}_t / \sum_{t'} \tilde{w}_{t'}$。
- **色**: $C = \sum_t w_t c_t$。

$c_t$ は三角形 $t$ の補間色（第 6 章の透視補正付き補間）です。この $C$ は頂点位置・深度・属性の微分可能な関数なので、逆伝播で勾配が得られます。

---

## 10.4 ハイパーパラメータ（blend 係数・スケール）と安定性

### 10.4.1 温度 $\tau$（深度のソフトマックス）

**$\tau$** は深度のソフトマックスにおける **温度** です。

- **小さい $\tau$**: 手前の三角形に重みが集中し、見た目はハードに近い。勾配は主に手前の三角形に流れる。ただし $\tau \to 0$ に近づけると **勾配が急** になり、数値的に不安定になりやすい。
- **大きい $\tau$**: 複数三角形に重みが分散し、境界がぼやける。勾配は多くの三角形に配分され、学習の初期では有効なことがある。

**アニーリング**: 学習の初期は $\tau$ を大きめにし、徐々に小さくして、最終的にはほぼハードな選択に近づける、というスケジュールがよく使われます。

### 10.4.2 スケール $\alpha$（内外判定の鋭さ）

**$\alpha$** は、エッジ関数をシグモイドに入れるときの **スケール** です。

- **大きい $\alpha$**: 内側/外側の切り替えが鋭く、エッジはシャープに近い。境界付近で $\sigma'$ が大きくなり、勾配が大きくなりうる。
- **小さい $\alpha$**: 境界がなだらかで、エッジがぼやける。勾配は穏やかだが、画像がソフトになる。

$\alpha$ も、学習の進行に応じて大きくする **アニーリング** が行われることがあります。

### 10.4.3 数値安定性の工夫

- **ソフトマックスの安定化**: $\exp(-d_t/\tau)$ は $d_t$ が極端なときオーバーフローするため、**最大値を引く** テクニック（$e^{x_t - \max_k x_k}$）で安定化する。
- **ログ空間**: 重みの積を扱う場合、ログを取って和で計算し、最後に exp で戻すと、アンダーフローを防げる。
- **クリッピング**: 重みや中間値を適切な範囲にクリップし、勾配の爆発を抑える。

これらは Part V（実装編）の数値安定性（第 12 章）でも再度扱います。

### 10.4.4 解析的勾配との比較

| 観点 | ソフトラスタ | 解析的（nvdiffrast 等） |
|------|--------------|---------------------------|
| 境界の見た目 | ぼやけがち | シャープ |
| 勾配の決定性 | 温度・スケールに依存 | 決定的 |
| 実装の複雑さ | 比較的簡単 | エッジ・シルエットの処理が必要 |
| 安定性 | ハイパーパラメータに敏感 | 数式で一貫して定義 |

ソフトラスタは **プロトタイプや研究** に適し、本格的な逆レンダリングや nvdiffrast 相当を目指す場合は **解析的勾配**（第 11 章）を実装する、という使い分けが一般的です。

---

## 10.5 まとめと次章への接続

- **離散から連続へ**: シグモイドで内外判定を、ソフトマックスで深度選択を連続化。ピクセルごとの「重み」で色を合成する。
- **ピクセルごとの重みと勾配**: $w_{t,i,j}$ が微分可能なので、損失から頂点位置・深度・属性へ勾配が流れる。境界でも勾配が途切れない。
- **Soft Rasterizer / DIB-R**: 上記の枠組みで、$m_t$（属する度合い）と深度のソフトマックスで $w_t$ を定義。単一画像からの 3D 推定などで広く利用される。
- **ハイパーパラメータ**: 温度 $\tau$ とスケール $\alpha$ で鋭さを制御。アニーリングと数値安定化（ソフトマックス安定化・ログ空間・クリッピング）が重要。

次章（第 11 章）では **サブディビジョンと解析的勾配** を扱い、nvdiffrast の設計思想、三角形の細分割と勾配の流れ、アンチエイリアシングと勾配の一貫性、エッジ・頂点・面に沿った勾配、およびシルエット勾配の扱いを学びます。ソフト化ではなく「見えている結果に基づく式」で勾配を定義する路線の完成です。

---

*前: [第 9 章 古典的アプローチ](Chapter09.md) | 次: [第 11 章 サブディビジョンと解析的勾配](Chapter11.md)*
