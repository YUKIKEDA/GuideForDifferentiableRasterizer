# 第9章 古典的アプローチ

Part IV では **微分可能ラスタライゼーションの理論** を体系的に扱います。本章はその入口として、**古典的アプローチ** を学びます。OpenDR（Loper & Black, 2014）の考え方（9.1）、**有限差分** による数値勾配の限界（9.2）、そして **解析的勾配** が必要になる理由（9.3）を整理します。現代のソフトラスタや nvdiffrast は、この「数値では不十分だから解析的に勾配を定義する」という流れの上にあります。

---

## 9.1 OpenDR（Loper & Black）の考え方

### 9.1.1 OpenDR とは

**OpenDR**（Differentiable Renderer, Loper & Black, ECCV 2014）は、**メッシュを入力とする微分可能レンダラーの先駆け** です。従来のレンダリングパイプライン（投影・ラスタライゼーション・シェーディング）を、**最適化で使える形** で実装し、損失から頂点位置やカメラパラメータへ勾配を伝えることを目指しました。

- **動機**: 画像から 3D 形状やテクスチャを推定する逆問題で、勾配降下法を使うには「レンダリング」が微分可能である必要がある。
- **課題**: ラスタライゼーションには離散演算（ピクセル帰属・深度テスト）が含まれるため、そのままでは自動微分が使えない。

OpenDR では、この課題に対して **有限差分** による勾配の近似や、**解析的な勾配** の導出を試み、微分可能レンダリングの実現可能性を示しました。

### 9.1.2 アプローチの骨子

OpenDR の考え方の要点は次のとおりです。

1. **レンダリングを関数として扱う**: シーンパラメータ（頂点位置・カメラなど）$\theta$ を入力、画像 $\mathbf{I}(\theta)$ を出力とする関数とみなす。
2. **勾配の必要性**: 損失 $\mathcal{L}(\mathbf{I}(\theta), \mathbf{I}_{\text{obs}})$ を最小化するために $\frac{\partial \mathcal{L}}{\partial \theta}$ が必要。
3. **離散部分の扱い**: ラスタライザの離散性に対して、(a) 有限差分で $\frac{\partial \mathbf{I}}{\partial \theta}$ を近似する、あるいは (b) 可能な範囲で解析的な導出を行う。

当時の実装では、計算コストと実装の複雑さのバランスから、**有限差分** を補助的に使いつつ、**解析的勾配** の重要性が認識されました。その後の Soft Rasterizer や nvdiffrast は、この「解析的に勾配を定義する」路線を発展させています。

### 9.1.3 歴史的な位置づけ

OpenDR 以降、

- **ソフトラスタライゼーション**: 離散判定をソフトマックスなどで連続化し、勾配を「自然に」流す（第 10 章）。
- **解析的勾配**: 見えている結果に基づいて、補間式・エッジ・シルエットの勾配を式で定義する（第 11 章、nvdiffrast）。

の二つの流れが明確になりました。本章で扱う **有限差分の限界** と **解析的勾配の必要性** は、どちらの流れを選ぶにせよ「なぜ数値微分だけでは足りないか」を理解するための土台です。

---

## 9.2 有限差分と数値勾配の限界

### 9.2.1 有限差分の定義

関数 $f(\theta)$ の、パラメータ $\theta$ に関する勾配を **数値的に** 近似する方法が **有限差分** です。$i$ 番目の成分について、

$$
\frac{\partial f}{\partial \theta_i} \approx \frac{f(\theta + \varepsilon \mathbf{e}_i) - f(\theta)}{\varepsilon} \quad \text{（前進差分）}
$$

または

$$
\frac{\partial f}{\partial \theta_i} \approx \frac{f(\theta + \varepsilon \mathbf{e}_i) - f(\theta - \varepsilon \mathbf{e}_i)}{2\varepsilon} \quad \text{（中心差分）}
$$

とします。$\mathbf{e}_i$ は $i$ 番目だけ 1 の単位ベクトル、$\varepsilon$ は小さな正の数です。

### 9.2.2 計算コスト

パラメータが $n$ 個あるとき、**前進差分** では $n$ 回の **順伝播**（レンダリング）が必要です。中心差分なら $2n$ 回です。  
メッシュの頂点数は数千〜数百万になり得るため、$n$ が非常に大きいと、**1 回の勾配計算のためにレンダリングを数百万回** 行うことになり、現実的ではありません。  
逆伝播（解析的または自動微分）なら、**順伝播 1 回 ＋ 逆伝播 1 回** で全パラメータへの勾配が得られるため、コストの差は圧倒的です。

### 9.2.3 数値的な不安定性

- **$\varepsilon$ の選び方**: $\varepsilon$ が大きいと **打ち切り誤差**（微分の近似誤差）が増える。$\varepsilon$ が小さすぎると **桁落ち** により $f(\theta+\varepsilon\mathbf{e}_i) - f(\theta)$ の有効桁が減り、勾配のノイズが大きくなる。
- **離散性との相性**: ラスタライザの出力は、$\theta$ を少し動かしただけで **ピクセル帰属が切り替わる** ことがある。そのとき $f$ はジャンプするため、有限差分は「その点での微分」ではなく、隣の状態との差を反映した不安定な値になりやすい。
- **0/1 の境界**: エッジ付近では、$\varepsilon$ の向きによって「属する三角形が変わる」か「変わらないか」が変わる。得られる勾配が方向に強く依存し、最適化が振動したり、勾配が 0 に近いと誤解されたりする。

### 9.2.4 まとめ：有限差分の限界

| 問題 | 内容 |
|------|------|
| **コスト** | パラメータ数 $n$ に比例して順伝播が増える。大規模メッシュでは非現実的。 |
| **精度** | $\varepsilon$ の選択に敏感。打ち切り誤差と桁落ちのトレードオフ。 |
| **離散性** | ピクセル帰属・深度の切り替えで出力がジャンプ。微分の近似が不安定。 |

このため、**実用的な微分可能ラスタライザ** では、有限差分は **デバッグや勾配チェック** に留め、本番の学習には **解析的（またはソフト化による連続な）勾配** を使うのが標準です。

---

## 9.3 解析的勾配の必要性

### 9.3.1 なぜ解析的か

**解析的勾配** とは、数値近似ではなく、**式を微分して得た偏微分** を使って勾配を計算する方法です。

- **一貫性**: 離散的な切り替えが起きる点でも、「見えている状態」に基づいて「この頂点をこう動かしたら、補間結果はこう変わる」という **決定的な式** で勾配を定義できる。
- **コスト**: 順伝播 1 回 ＋ 逆伝播 1 回で全パラメータに勾配が届く。パラメータ数に比例した追加の順伝播が不要。
- **安定性**: $\varepsilon$ に依存せず、同じ入力に対して同じ勾配が得られる。最適化の収束が予測しやすい。

### 9.3.2 ラスタライザで解析的に扱うもの

第 5 章・第 6 章で学んだように、ラスタライザで **離散的** なのは主に次の三つです。

1. **ピクセル帰属**（どの三角形がそのピクセルを覆うか）
2. **深度テスト**（手前の三角形の選択）
3. **エッジ**（境界でのシルエットの移動）

**解析的アプローチ** では、

- 順伝播では従来どおり離散的なラスタライゼーション・深度テストを行う（したがって画像はシャープ）。
- 逆伝播では、「そのピクセルに **実際に寄与した** 三角形と重心座標」だけに注目し、**補間式の微分**（第 6 章）で頂点・属性への勾配を計算する。
- エッジ・境界ピクセルでは、**シルエット勾配**（輪郭の移動に対応する勾配）を追加で定義する（第 11 章）。

これにより、「どの三角形に勾配を流すか」が **決定的** になり、有限差分のような不安定さを避けられます。

### 9.3.3 ソフト化との役割分担

- **ソフトラスタライゼーション**（第 10 章）: ピクセル帰属・深度を **連続な重み** で近似する。実装は比較的簡単だが、境界がぼやけがちで、重みの設計に依存する。
- **解析的勾配**（第 11 章）: 離散的な「見えている結果」を前提に、**式で勾配を定義** する。境界はシャープで、勾配は決定的。実装は複雑だが、nvdiffrast のような本格的なライブラリの基盤になる。

両方とも「有限差分に頼らない」という点で共通しており、本教材では **解析的勾配** を nvdiffrast 相当の目標として、理論と実装の両方で詳しく扱います。

### 9.3.4 デバッグにおける有限差分の使い方

解析的勾配を実装したあと、**正しさの検証** には有限差分が有用です。  
少数のパラメータ（例: 1 頂点の 1 成分）だけを動かし、$\varepsilon$ を小さくして中心差分で数値勾配を計算し、解析的勾配と比較する **勾配チェック** を行います。このときは $n$ が小さいのでコストは許容でき、離散的な切り替えが起きない範囲で比較すれば、解析的実装のバグ発見に役立ちます（Part V 第 14 章）。

---

## 9.4 まとめと次章への接続

- **OpenDR**: 微分可能レンダリングの古典的仕事。勾配の必要性と、離散部分の扱い（有限差分・解析的）の端緒を示した。
- **有限差分の限界**: コスト（$n$ 回の順伝播）、数値的な不安定性（$\varepsilon$・桁落ち）、離散性（ピクセル帰属のジャンプ）のため、本番の学習には向かない。勾配チェックには有効。
- **解析的勾配の必要性**: 決定的・低コスト・安定した勾配を得るために、補間式の微分とシルエット勾配を式で定義する路線が不可欠。

次章（第 10 章）では **ソフトラスタライゼーション** を扱い、離散判定をソフトマックス・シグモイドで連続化する定式化、Soft Rasterizer / DIB-R 系の考え方、およびハイパーパラメータと安定性を学びます。そのあと第 11 章で解析的勾配（nvdiffrast の設計）に進みます。

---

*前: [第 8 章 テクスチャとシェーディング](../Part03/Chapter08.md) | 次: [第 10 章 ソフトラスタライゼーション](Chapter10.md)*
