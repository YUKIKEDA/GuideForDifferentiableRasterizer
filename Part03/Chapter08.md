# 第8章 テクスチャとシェーディング

第6章で重心座標による属性補間、第7章でアンチエイリアシングを学びました。本章では **テクスチャ** と **シェーディング** を、微分可能ラスタライザの文脈で整理します。UV マッピングとテクスチャサンプリング（8.1）、法線とライティングとその勾配（8.2）、**微分可能なテクスチャサンプリング**（8.3）、そして Mipmap / LOD と勾配（8.4）を扱います。逆レンダリングではテクスチャ最適化が頻出なので、サンプリングの逆伝播を正確に理解することが重要です。

---

## 8.1 UV マッピングとテクスチャサンプリング

### 8.1.1 UV 座標とは

**UV** は、3D 面上の点を **2D テクスチャ空間** に写すための座標です。各頂点に $(u, v) \in [0,1]^2$（またはその範囲外）が割り当てられ、ラスタライザでは第6章の補間式（透視補正付き）でピクセルごとの UV が得られます。

$$
(u_{\text{frag}}, v_{\text{frag}}) = \text{interpolate}((u_0,v_0), (u_1,v_1), (u_2,v_2);\; \lambda)
$$

ここで $\lambda$ は重心座標 $(1-u-v, u, v)$ と $1/w$ 補間の重みです。補間式は微分可能なので、**UV の頂点への勾配** は第6章の属性補間の微分で既にカバーされています。

### 8.1.2 テクスチャサンプリング

**テクスチャ** は離散的な画像（ Texel ）の配列です。連続な UV $(u, v)$ に対して色を取得する操作が **サンプリング** です。

- **最近傍（Nearest）**: 一番近い Texel の色をそのまま使う。離散的で、UV が少し動いても同じ Texel を指す限り出力は不変 → 境界で勾配が 0 になる。
- **線形補間（Bilinear）**: 周囲 4 Texel を線形補間する。連続な関数になるので、**UV に関する微分** が定義できる。

微分可能レンダリングでは、少なくとも **双線形補間** 以上の連続なサンプリングが前提になります。そのうえで、**テクスチャ値（Texel）** と **UV** の両方に対する勾配を逆伝播します。

### 8.1.3 サンプリングの数式

テクスチャを $T(i, j)$（$i, j$ は整数インデックス）とし、正規化された UV を $(u, v) \in [0,1]^2$ とすると、画像サイズ $(W_T, H_T)$ のとき

$$
s = u \cdot (W_T - 1), \quad t = v \cdot (H_T - 1)
$$

で連続座標を取り、周囲 4 点 $T(\lfloor s \rfloor, \lfloor t \rfloor)$ などで **双線形補間** すると、

$$
C(u, v) = (1-\alpha)(1-\beta)\, T_{00} + \alpha(1-\beta)\, T_{10} + (1-\alpha)\beta\, T_{01} + \alpha\beta\, T_{11}
$$

ただし $\alpha = s - \lfloor s \rfloor$, $\beta = t - \lfloor t \rfloor$, $T_{00} = T(\lfloor s \rfloor, \lfloor t \rfloor)$ などです。$C$ は $u$, $v$ および各 $T_{ij}$ の関数なので、これらについて偏微分すれば勾配が得られます。

---

## 8.2 法線・ライティングとその勾配

### 8.2.1 法線の補間

頂点法線 $\mathbf{n}_0, \mathbf{n}_1, \mathbf{n}_2$ は、第6章の透視補正付き補間で **フラグメント法線** $\mathbf{n}$ を得たあと、**正規化** してシェーディングに使います。

$$
\mathbf{n}_{\text{raw}} = \text{interpolate}(\mathbf{n}_0, \mathbf{n}_1, \mathbf{n}_2;\; \lambda), \quad \mathbf{n} = \frac{\mathbf{n}_{\text{raw}}}{\|\mathbf{n}_{\text{raw}}\|}
$$

正規化は微分可能です。$\mathbf{n} = \mathbf{v} / \|\mathbf{v}\|$ のとき、

$$
\frac{\partial \mathbf{n}}{\partial \mathbf{v}} = \frac{1}{\|\mathbf{v}\|} \left( \mathbf{I} - \mathbf{n}\mathbf{n}^\top \right)
$$

なので、上流から $\partial L / \partial \mathbf{n}$ が渡されれば、$\partial L / \partial \mathbf{n}_{\text{raw}}$ を計算でき、そこから頂点法線への勾配は補間の逆伝播で得られます。

### 8.2.2 簡単なライティングモデル

**拡散（Diffuse）** を例にすると、ライト方向 $\mathbf{l}$、法線 $\mathbf{n}$、色 $\mathbf{c}$ に対して

$$
I_{\text{diff}} = \max(0, \mathbf{n} \cdot \mathbf{l})\, \mathbf{c}
$$

のような形になります。**$\max(0, \cdot)$** は 0 で微分不可能ですが、実務では **勾配を 0 または 1 とする**（サブグラディエント）か、**滑らかな近似**（ソフトプラスなど）を使います。  
$I_{\text{diff}}$ は $\mathbf{n}$, $\mathbf{c}$, $\mathbf{l}$ の関数なので、$\partial L / \partial I_{\text{diff}}$ が上流から渡されれば、$\partial L / \partial \mathbf{n}$, $\partial L / \partial \mathbf{c}$ は連鎖律で計算できます。**反射（Specular）** も、Phong や Blinn-Phong の式は微分可能に書けるため、同様に勾配を流せます。

### 8.2.3 逆レンダリングでの役割

形状・テクスチャ・照明の逆最適化では、**法線** と **ライティング** の勾配が重要です。

- 法線は頂点位置（メッシュ形状）や頂点法線属性に依存するため、$\partial L / \partial \mathbf{n}$ から頂点や法線属性へ勾配が伝わる。
- 照明パラメータ（方向・強度）を最適化する場合も、ライティング式のそれらに関する偏微分が必要。

Part VII（応用）で、テクスチャ・形状・照明の逆最適化を扱うときに、この章の勾配の流れを再利用します。

---

## 8.3 微分可能なテクスチャサンプリング

### 8.3.1 逆伝播で必要な勾配

損失 $L$ がピクセル色 $C$（テクスチャサンプリングの出力）に依存しているとき、逆伝播では次の二つが必要です。

1. **UV への勾配** $\frac{\partial L}{\partial u}$, $\frac{\partial L}{\partial v}$  
   → サンプリング式 $C(u, v, T)$ の $u$, $v$ に関する偏微分。双線形補間なら連続なので定義できる。この勾配はさらに **頂点 UV** や **頂点位置**（UV は補間で得られるため）へ伝播する。
2. **テクスチャ（Texel）への勾配** $\frac{\partial L}{\partial T(i,j)}$  
   → 各 Texel がサンプリングに寄与した割合に応じて、上流の勾配を配分する。双線形補間では、$(u,v)$ に依存する重みで 4 Texel に加算（accumulate）する。

### 8.3.2 双線形補間の backward

$C = (1-\alpha)(1-\beta) T_{00} + \cdots$ の形なので、

$$
\frac{\partial C}{\partial T_{00}} = (1-\alpha)(1-\beta), \quad \frac{\partial C}{\partial T_{10}} = \alpha(1-\beta), \quad \frac{\partial C}{\partial T_{01}} = (1-\alpha)\beta, \quad \frac{\partial C}{\partial T_{11}} = \alpha\beta
$$

したがって、上流から $g = \partial L / \partial C$ が渡されたとき、

$$
\frac{\partial L}{\partial T_{00}} = g \cdot (1-\alpha)(1-\beta), \quad \frac{\partial L}{\partial T_{10}} = g \cdot \alpha(1-\beta), \quad \ldots
$$

と各 Texel に加算します。複数ピクセルから同じ Texel が参照され得るので、**加算** で勾配を蓄積する点が重要です。  
$u$, $v$ への勾配は、$C$ の $u$, $v$ 経由の依存（$s = u(W_T-1)$, $t = v(H_T-1)$, $\alpha$, $\beta$ の定義）を連鎖律で辿れば得られます。

### 8.3.3 実装の注意点

- **グリッドサンプリング**: PyTorch の `grid_sample` は双線形（または最近傍）で、`mode='bilinear'` なら微分可能。カスタムで書く場合も、同じ式で forward/backward を一致させる。
- **UV の範囲外**: クランプやリピート（wrap）を使う場合、境界で微分が不連続になることがある。クランプなら境界で勾配を 0 にするか、サブグラディエントを定義する。
- **テクスチャのメモリ**: 高解像度テクスチャでは、勾配バッファも同じ解像度になり、メモリと計算コストが増える。Mipmap と組み合わせる場合は 8.4 の扱いが効く。

---

## 8.4 Mipmap / LOD と勾配（高解像度テクスチャの扱い）

### 8.4.1 Mipmap の目的

**Mipmap** は、元テクスチャを 1/2 ずつにダウンサンプルしたレベルを事前に用意し、**ピクセルがカバーする UV 範囲の大きさ**（つまり距離・縮小率）に応じて適切なレベルをサンプリングする手法です。遠くのものや斜めから見た面では低解像度レベルを使うことで、エイリアシングを抑えつつコストを削減します。

### 8.4.2 LOD の計算

**LOD（Level of Detail）** は、サンプリングに使う Mipmap レベル（連続値）です。スクリーン空間での UV の変化率（$\partial u/\partial x$, $\partial v/\partial y$ など）から、ピクセルがテクスチャ空間でカバーする範囲の大きさを推定し、それに応じて LOD を決めます。  
LOD が大きいほど粗いレベルを参照するため、**LOD は視点・頂点位置・UV の関数** です。微分可能にするには、**LOD の選択** を連続化するか、あるいは **使うレベルを固定** して、そのレベル内でのサンプリングだけを微分する、といった設計になります。

### 8.4.3 勾配の扱い

- **LOD を固定**: 逆伝播では、サンプリングに使ったレベルだけを考え、そのレベル内の Texel と UV にだけ勾配を流す。実装が簡単で、多くの逆レンダリングではこれで十分なことが多い。
- **LOD を連続化**: 二つのレベルを線形補間してサンプリングする（三線形補間）場合、LOD に関する微分も定義できるが、実装と勾配の式が複雑になる。
- **高解像度テクスチャ**: 勾配を全 Texel に持つと重いため、**粗いレベルだけ勾配を更新する**、または **重要領域だけ高解像度** にするなどの工夫が実務では有効（Part VII）。

nvdiffrast や PyTorch3D では、テクスチャサンプリングは双線形＋必要に応じて Mipmap を利用し、勾配はサンプリングに使ったレベル・UV に沿って流す形が一般的です。

---

## 8.5 まとめと次章への接続

- **UV とテクスチャサンプリング**: UV は補間で得られ、テクスチャは双線形補間で連続にサンプリングする。逆伝播では **UV への勾配** と **Texel への勾配** の両方を計算する。
- **法線・ライティング**: 法線の補間と正規化、簡単な拡散式は微分可能。$\max(0,\cdot)$ はサブグラディエントか滑らか近似で扱う。
- **微分可能テクスチャ**: 双線形の forward/backward を一致させ、Texel への勾配は加算で蓄積。UV の範囲外や境界に注意。
- **Mipmap / LOD**: LOD を固定して勾配を流すのが現実的。高解像度テクスチャでは勾配のメモリと更新範囲のトレードオフを考慮する。

Part III はここまでで、ラスタライゼーション・補間・アンチエイリアシング・テクスチャとシェーディングの数学と微分を一通り押さえました。  
次章（第 9 章、Part IV）からは **微分可能ラスタライゼーションの理論** に入り、古典的アプローチ（OpenDR）、ソフトラスタライゼーション、そしてサブディビジョンと解析的勾配（nvdiffrast の設計）を学びます。

---

*前: [第 7 章 アンチエイリアシング](Chapter07.md) | 次: [第 9 章 古典的アプローチ](../Part04/Chapter09.md)*
