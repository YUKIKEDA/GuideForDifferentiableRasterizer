# 第7章 アンチエイリアシング

第6章で三角形のラスタライゼーションと補間の数学を押さえました。本章では、**アンチエイリアシング（AA）** に焦点を当てます。離散ピクセルで連続的なエッジを描くときの **ジャギー** の原因（7.1）、それを緩和する **MSAA** と **解析的アンチエイリアシング**（7.2）、そして **微分可能ラスタライザ** において境界をどう扱うか（7.3）を整理します。境界の扱いは、Part IV の解析的勾配（nvdiffrast）や Part VI のアンチエイリアシング組み込みと直結します。

---

## 7.1 エイリアシングの原因

### 7.1.1 離散サンプリングとナイキスト

画像は **離散的なピクセル** の格子で表現されます。連続なシーン（三角形のエッジやテクスチャの細かい模様）をこの格子で **サンプリング** すると、元の信号に含まれる高周波成分が、サンプリング周波数（解像度）を超えると **エイリアシング** として現れます。  
ナイキスト定理では、サンプリング周波数の半分を超える周波数成分は正しく復元できず、折り返し（エイリアス）となってジャギーやモアレの原因になります。

### 7.1.2 三角形エッジのジャギー

三角形の **エッジ** は、連続的には無限に細い線ですが、ピクセルでは **そのピクセルが内側か外側か** の二値で表現されます。

- **ピクセル中心** が三角形の内側にあればそのピクセルは塗りつぶし、外側なら塗らない、という判定にすると、エッジは **階段状（ジャギー）** になる。
- エッジが斜めのとき、ピクセル境界で 0/1 が切り替わるため、見た目がギザギザになる。
- アニメーションでは、エッジがピクセル境界を横切るたびに **ピクセルのオン/オフがパッと切り替わる** ため、フリッカーやクロールも生じやすい。

したがって、**エッジのサンプリング** をどう扱うかが、画質と微分可能ラスタライザの **境界での勾配** の両方に効きます。

### 7.1.3 エイリアシングと微分可能性

第5章で学んだように、**ピクセル帰属の 0/1 の切り替え** は微分の障壁です。アンチエイリアシングは、

- **見た目** のため: エッジを滑らかにしてジャギーを減らす。
- **微分可能性** のため: 境界付近で「どれだけその三角形に寄与するか」を連続的に扱い、勾配が 0 にならないようにする、

という二つの動機で重要になります。ソフトラスタライザでは後者（連続な重み）が主、解析的 AA では前者（見た目の滑らかさ）と後者（境界での勾配の一貫性）の両方を意識した設計になります。

---

## 7.2 マルチサンプル（MSAA）と解析的アンチエイリアシング

### 7.2.1 マルチサンプルアンチエイリアシング（MSAA）

**MSAA** では、1 ピクセルあたり **複数のサンプル点** を用意し、それぞれで三角形の内外判定を行います。ピクセルごとの出力は、**内側だったサンプル数の割合**（カバレッジ）で、背景色と三角形の色をブレンドするなどして決めます。

- **長所**: ハードウェアで広くサポートされ、エッジのジャギーが軽減される。
- **微分可能ラスタライザとの関係**: サンプルごとに 0/1 の判定をすると、今度は **サンプル単位** で離散性が残る。勾配を考える場合は、「ピクセル全体のカバレッジ」を連続関数で近似するか、解析的にエッジとピクセルの重なり面積を計算する方が、勾配の定義が明確になる。

### 7.2.2 解析的アンチエイリアシング

**解析的アンチエイリアシング** では、**ピクセル領域**（四角形や円盤）と **三角形** の **重なり面積** を、式で計算します。

- ピクセル $(i, j)$ の領域（例: 単位正方形 $[i, i+1] \times [j, j+1]$）と三角形の交差部分の面積を $A_{ij}$ とし、三角形の面積で割った値を **カバレッジ** や **アンチエイリアスされた重み** として使う。
- エッジがピクセルをまたぐ場合、面積は **エッジの位置** の連続関数になるため、**境界でも勾配が定義しやすい**。
- 実装は、エッジとピクセル矩形の交点を求め、多角形の面積を計算するなど、やや重いが、**決定的で微分可能な** 結果が得られる。

nvdiffrast では、このような解析的 AA をオプションで組み込み、**境界ピクセル** での描画と **シルエット勾配** の一貫性を両立させています（Part IV 第 11 章、Part VI 第 17 章）。

### 7.2.3 スーパーサンプリングとの違い

**スーパーサンプリング** は、解像度を上げてレンダリングしたあとダウンサンプルする方法です。高解像度で細かくサンプリングするためジャギーは減りますが、**計算コスト** が大きく、微分可能ラスタライザで「どのサンプルが境界をまたいだか」を追うと実装が複雑になります。解析的 AA は、**1 ピクセルあたり 1 回** の幾何計算で重なり面積を求めるため、コストと勾配の明確さのバランスが取りやすいです。

---

## 7.3 微分可能な境界の扱い

### 7.3.1 境界ピクセルと「どれに属するか」

**境界ピクセル** とは、三角形のエッジにまたがるピクセルです。  
通常のラスタライザでは、ピクセル中心が内側なら 1、外側なら 0 と二値化するため、境界付近で **属する三角形が 1 ピクセル幅で切り替わる** ことになります。微分可能にするには、

- **ソフト化**: 境界付近で 0/1 ではなく連続な重み（シグモイドやソフトマックス）を使い、複数三角形に勾配を配分する。
- **解析的**: 「見えている三角形」について補間式の勾配を流し、**エッジを動かすような頂点の変化** には、別途 **シルエット（輪郭）勾配** を定義する。

のいずれか、または組み合わせになります。

### 7.3.2 シルエット勾配

**シルエット勾配** は、**輪郭線の位置** が頂点の移動でどう変わるかに対応する勾配です。

- ピクセル帰属の「補間式の微分」だけでは、**エッジがピクセルを横切る** ような頂点の動き（＝シルエットが動く）に対する感度が捉えられない。
- 境界ピクセルでは、**エッジとピクセル領域の重なり** が頂点位置の関数なので、その面積（またはカバレッジ）を頂点で微分すると、シルエットを動かす方向への勾配が得られる。
- nvdiffrast では、境界ピクセルを検出し、エッジに沿った勾配に加えて、この **シルエット勾配** を加算することで、輪郭の変化に反応する学習ができるようにしています。

Part IV 第 11 章で、シルエット勾配の導出とエッジ・頂点への配分を詳述します。

### 7.3.3 解析的 AA と勾配の一貫性

解析的アンチエイリアシングでは、**ピクセルと三角形の重なり面積** を式で書くため、

- 順伝播: その面積（または面積に基づく重み）で色や深度をブレンドする。
- 逆伝播: 面積は頂点位置の連続関数なので、**面積の頂点に関する偏微分** を計算すれば、境界でも勾配が一貫して定義できる。

このように、**見た目**（滑らかなエッジ）と **勾配**（境界での感度）を同じ枠組みで扱えるのが、解析的 AA の利点です。Part IV では「アンチエイリアシングと勾配の一貫性」として、境界の扱いを先に決めてからエッジ・頂点への勾配を導出する流れを学びます。

### 7.3.4 実装時の注意

- **エッジ検出**: どのピクセルを「境界」とみなすか（隣接ピクセルとの属する三角形の違い、重心座標の閾値など）で、シルエット勾配を計算する範囲が変わる。
- **数値安定性**: エッジ上や頂点にごく近いピクセルでは、面積や重心座標が 0 に近く、勾配が不安定になりやすい。ε やクリッピングでガードする必要がある（Part VI 18 章）。
- **パフォーマンス**: 解析的 AA は全ピクセルで重なり面積を計算すると重いため、**境界付近のピクセルだけ** に限定するなどの最適化が現実的です。

---

## 7.4 まとめと次章への接続

- **エイリアシング**: 離散ピクセルによるサンプリングで、三角形エッジが階段状（ジャギー）になる。境界での 0/1 は微分の障壁でもある。
- **MSAA**: 複数サンプルでカバレッジを求める。勾配を考える場合は、解析的に面積を扱う方が一貫しやすい。
- **解析的 AA**: ピクセルと三角形の重なり面積を式で計算。境界でも勾配が定義でき、nvdiffrast などで採用される。
- **微分可能な境界**: ソフト化（連続重み）か、解析的（シルエット勾配・面積の微分）か。解析的では見た目と勾配の一貫性を両立できる。

次章（第 8 章）では **テクスチャとシェーディング** を扱い、UV マッピング・テクスチャサンプリング・法線とライティング、およびそれらの **微分可能な実装** と Mipmap まわりの勾配を学びます。Part III の数学の締めくくりになります。

---

*前: [第 6 章 三角形とスクリーン空間](Chapter06.md) | 次: [第 8 章 テクスチャとシェーディング](Chapter08.md)*
